
<link rel="import" href="../polymer/polymer.html">

<!--
A polymer client element for the stomp websocket protocol

Example:

    <stomp-client></stomp-client>

Example:

    <stomp-client>
      <h2>Hello stomp-client</h2>
    </stomp-client>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="stomp-client">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>
  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'stomp-client',
        socket: null,
        properties: {
          topic: {
            type: String,
            observer: '_onTopicChanged'
          },
          url: {
            type: String,
            observer: '_onUrlChanged'
          },
          lastmessage:{
            type: Object,
            notify: true
          },
          _stompClient:{
            type: Object,
            notify: true
          }
        },

        _onUrlChanged: function (newval,oldval) {
            if (newval) {
              this._createClient(newval);
            }
        },

        _onTopicChanged: function (newval,oldval) {
          if (newval) {
            this._connectClient(newval);
          }
        },

        open: function(){
          if(this.topic) {
            _connectClient(this.topic);
          }
        },


        send: function (message) {
          this.socket.send(message);
        },

        close: function () {
          if(this.socket) {
            this.socket.close();
          }
        },

        _onConnected: function () {
          this.fire('connected');
        },

        _onMessage: function (message) {
          this.lastmessage=message;
          this.fire('onmessage', message);
        },

        _connectClient: function (topic) {
          this._stompClient.connect({}, function() {
            stompClient.subscribe(topic, function(message){
              this._onMessage(message)
            })
            this._onConnected()
          })
        },

        _createClient: function(url){
          this._stompClient = Stomp.over( new SockJS(url))
        }
      })
    })();
  </script>
</dom-module>
